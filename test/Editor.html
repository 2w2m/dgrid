<!DOCTYPE html>
<html>
	<head>
		<title>Test Cell Editors</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta name="viewport" content="width=570" />
		<style type="text/css">
			@import "../../dojo/resources/dojo.css";
			@import "../../dijit/themes/claro/claro.css";
			@import "../css/skins/claro.css";
			.heading {
				font-weight: bold;
				padding-bottom: 0.25em;
			}
			#grid {
				margin: 10px;
				height: 15em;
				width: 500px;
			}
		</style>
		<script type="text/javascript" src="../../dojo/dojo.js"
			data-dojo-config="async: true, isDebug: true"></script>
		<script type="text/javascript">
			require(["dgrid/OnDemandGrid", "dgrid/Selection", "dgrid/Keyboard", "dgrid/Editor",
					"dojo/_base/declare", "dojo/on", "dojo/dom-construct",
					"dojo/store/Memory", "dojo/store/Observable", "dojo/data/ObjectStore", "dojo/domReady!"],
				function(Grid, Selection, Keyboard, Editor, declare, on, domConstruct, Memory, Observable, ObjectStore){
					var today = new Date(),
						form = document.getElementById("editorForm"),
						typesArea = document.getElementById("editorComponentTypes"),
						optionsData = [
							{ id: "1", name: "one" },
							{ id: "2", name: "two" },
							{ id: "3", name: "three" },
							{ id: "4", name: "four" },
							{ id: "5", name: "five" }
						],
						optionsLength = optionsData.length,
						optionsStore = new Memory({ data: optionsData }),
						optionsDataStore = new ObjectStore({
							objectStore: optionsStore,
							labelProperty: "name"
						}),
						CustomGrid = declare([Grid, Selection, Keyboard]),
						// define choices of component type which will be available in form
						componentTypes = {
							// native input types
							text: { generate: generateText },
							checkbox: { generate: generateBool },
							radio: { generate: generateBool },
							textarea: { generate: generateText },
							// TODO: support select?
							// Dijits
							"dijit/form/TextBox": { generate: generateText },
							"dijit/form/SimpleTextarea": { generate: generateText },
							"dijit/form/CheckBox": { generate: generateBool },
							"dijit/form/ValidationTextBox": {
								generate: generateText,
								editorArgs: { required: true }
							},
							"dijit/form/NumberSpinner": { generate: generateNumber },
							"dijit/form/DateTextBox": { generate: generateDate },
							"dijit/form/HorizontalSlider": {
								generate: generateNumber,
								editorArgs: { minimum: 0, maximum: 1000 }
							},
							"dijit/form/FilteringSelect": {
								generate: generateOptionValue,
								editorArgs: { store: optionsStore }
							},
							"dijit/form/Select": {
								generate: generateOptionValue,
								editorArgs: {
									store: optionsDataStore,
									// need to set width directly for Select to size correctly
									style: { width: "99%" }
								}
							}
						},
						optStr = "",
						i;
					
					// data generation functions used for populating store data,
					// used by different componentTypes
					function generateText() {
						return "generated text " + Math.floor(Math.random() * 1000);
					}
					function generateNumber() {
						return Math.floor(Math.random() * 1000);
					}
					function generateBool() {
						return Math.random() > 0.5 ? true : false;
					}
					function generateDate() {
						// return a date within the past year
						return new Date(today - Math.random() * 31536000000);
					}
					function generateOptionValue() {
						return optionsData[Math.floor(Math.random() * optionsLength)].id;
					}
					
					function getSelected(select){
						var options = select.options,
							i;
						for (i = options.length; i--;){
							if(options[i].selected){ return options[i].value; }
						}
					}
					
					form.onsubmit = function(){
						var
							editor = getSelected(form.elements.editor),
							editOn = getSelected(form.elements.editOn),
							deps = editor.indexOf("/") > -1 ? [editor] : [],
							options = componentTypes[editor],
							data = [],
							i;
						
						for (i = 0; i < 50; i++){
							data.push({ id: i, editor: options.generate() });
						}
						
						require(deps, function(ctor){
							window.grid && window.grid.destroy();
							domConstruct.create("div", { id: "grid" }, form, "after");
							
							window.grid = new CustomGrid({
								store: Observable(new Memory({ data: data })),
								columns: {
									"editor": Editor({
											autoSave: form.elements.autoSave.checked,
											editorArgs: options.editorArgs
										}, ctor || editor, editOn || undefined)
								}
							}, "grid");
						});
						
						return false;
					};
					
					// generate radios in editorComponentTypes div
					for(i in componentTypes){
						optStr += '<option value="' + i + '">' + i + "</option>";
					}
					domConstruct.place('<select name="editor">' + optStr + "</select>", typesArea);
					
					on(document.body, "dgrid-datachange", function(evt){
						console.log(evt.cell.row.id, " data changed: " + evt.oldValue + " -> " + evt.value);
					});
				});
		</script>
	</head>
	<body class="claro">
		<h2>Testing Editors</h2>
		(Testing editors using Dijit widgets requires the dijit package to be installed)
		<form id="editorForm">
			<p><label>Component type:
				<span id="editorComponentTypes"></span>
			</label></p>
			<p><label>editOn:
				<select name="editOn">
					<option value="" selected>none (always on)</option>
					<option value="click">click</option>
					<option value="dblclick">double-click</option>
					<option value="dgrid-cellfocusin">dgrid-cellfocusin</option>
				</select>
			</label></p>
			<p><label><input type="checkbox" name="autoSave" value="true"> autoSave</label></p>
			<div><button type="submit" id="editorFormSubmit">Recreate Grid</button></div>
		</form>
		<button type="button" id="save" onclick="grid.save()">Save</button>
	</body>
</html>
